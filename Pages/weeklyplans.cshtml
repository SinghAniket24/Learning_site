@page "{id:int}"
@model Learning_site.Pages.WeeklyPlansModel
@{
    ViewData["Title"] = "Weekly Plan";
}

@*
<div class="container mt-5">
    <h2 class="mb-4 text-center text-primary fw-bold">📅 @Model.PlanTitle</h2>

    @if (Model.DailyPlan == null || !Model.DailyPlan.Any())
    {
        <div class="alert alert-warning text-center">No plan data found.</div>
    }
    else
    {
        @foreach (var day in Model.DailyPlan)
        {
            <div class="mb-5 p-3 day-section rounded shadow-sm border" id="day-@day.Day">
                <h4 class="mb-4 text-secondary fw-semibold">Day @day.Day</h4>

                <div class="row g-4">
                    @foreach (var video in day.Videos)
                    {
                        var videoId = video.VideoUrl.Split('=')[1];
                        <div class="col-md-4 video-card" id="video-@videoId">
                            <div class="card h-100 shadow-sm border-0 position-relative overflow-hidden">
                                <img src="@video.ThumbnailUrl" class="card-img-top" style="height:180px; object-fit:cover;">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title text-truncate">@video.Title</h5>
                                    <p class="card-text mb-1"><strong>Duration:</strong> @video.Duration</p>
                                    <p class="card-text mb-2"><strong>Channel:</strong> @video.ChannelName</p>

                                    <div class="d-flex align-items-center mt-auto">
                                        <!-- Tick Checkbox -->
                                        <div class="form-check me-2">
                                            <input class="form-check-input" type="checkbox"
                                                   id="tick-@videoId"
                                                   onclick="markCompleted('@Model.PlanId','@videoId')">
                                            <label class="form-check-label" for="tick-@videoId">
                                                Complete
                                            </label>
                                        </div>

                                        <!-- Watch Button -->
                                        <button class="btn btn-outline-primary btn-sm ms-auto watch-btn"
                                                data-videoid="@videoId"
                                                data-planid="@Model.PlanId">
                                            Watch ▶
                                        </button>
                                    </div>

                                    <!-- Completed Badge -->
                                    <span id="label-@videoId" class="badge bg-success mt-2 position-absolute top-0 end-0 me-2 mt-2" style="display:none; font-size:0.8rem; padding:0.5em 0.7em;">
                                        ✔ Completed
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }

    <a asp-page="/MyPlans" class="btn btn-secondary mt-3">⬅ Back to My Plans</a>
</div>

<style>
    .day-section {
        background-color: #f8f9fa;
        transition: background-color 0.5s;
    }

    .highlight {
        background-color: #fff3cd !important;
    }

    .card:hover {
        transform: translateY(-5px);
        transition: 0.3s;
    }

    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }

    .form-check-label {
        user-select: none;
    }

    .card-title {
        font-size: 1rem;
        font-weight: 500;
    }
</style>

<script>
    function markCompleted(planId, videoId) {
        window.PlanStorage.markVideoCompleted(planId, videoId);
        document.getElementById("tick-" + videoId).style.display = "none";
        document.getElementById("label-" + videoId).style.display = "inline-block";
        localStorage.setItem("updateProgress-" + planId, new Date());
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Highlight video/day from query param
        const urlParams = new URLSearchParams(window.location.search);
        const highlightVideoId = urlParams.get('highlightVideo');
        if (highlightVideoId) {
            const videoEl = document.getElementById("video-" + highlightVideoId);
            if (videoEl) {
                videoEl.scrollIntoView({ behavior: "smooth", block: "center" });
                const dayEl = videoEl.closest('.day-section');
                if (dayEl) dayEl.classList.add("highlight");
            }
        }

        // Update completed badges
        @foreach (var day in Model.DailyPlan)
        {
                @foreach (var video in day.Videos)
                {
                        var vid = video.VideoUrl.Split('=')[1];
                        <text>
                            if(window.PlanStorage.isVideoCompleted('@Model.PlanId','@vid')) {
                                document.getElementById("tick-@vid").style.display = "none";
                                document.getElementById("label-@vid").style.display = "inline-block";
                            }
                        </text>
                }
        }

        // Add click event to Watch buttons
        document.querySelectorAll('.watch-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const videoId = btn.getAttribute('data-videoid');
                const planId = btn.getAttribute('data-planid');
                const progressKey = `videoProgress-${planId}-${videoId}`;
                const start = localStorage.getItem(progressKey) || 0;

                // Pass highlightVideo param to return to exact video
                window.location.href = `/VideoPlayer/${videoId}?planId=${planId}&start=${start}&highlightVideo=${videoId}`;
            });
        });
    });
</script>
*@



<div class="container mt-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">📅 @Model.PlanTitle</h2>
        <a asp-page="/MyPlans" class="btn btn-outline-secondary">⬅ Back</a>
    </div>

    <!-- Overall Progress -->
    <div class="mb-4">
        <label class="fw-semibold">Overall Progress</label>
        <div class="progress" style="height: 20px;">
            <div id="overall-progress" class="progress-bar bg-success" role="progressbar" style="width:0%">
                0%
            </div>
        </div>
    </div>

    @if (Model.DailyPlan == null || !Model.DailyPlan.Any())
    {
        <div class="alert alert-warning text-center">No plan data found.</div>
    }
    else
    {
        <div class="accordion" id="weeklyAccordion">
            @for (int i = 0; i < Model.DailyPlan.Count; i++)
            {
                var day = Model.DailyPlan[i];
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-@day.Day">
                        <button class="accordion-button @(i > 0 ? "collapsed" : "")" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapse-@day.Day" aria-expanded="@(i == 0 ? "true" : "false")"
                            aria-controls="collapse-@day.Day">
                            Day @day.Day
                            <span class="badge bg-light text-dark ms-2" id="progress-day-@day.Day">0 / @day.Videos.Count</span>
                        </button>
                    </h2>
                    <div id="collapse-@day.Day" class="accordion-collapse collapse @(i == 0 ? "show" : "")"
                        aria-labelledby="heading-@day.Day" data-bs-parent="#weeklyAccordion">
                        <div class="accordion-body">
                            @foreach (var video in day.Videos)
                            {
                                var videoId = video.VideoUrl.Split('=')[1];
                                <div class="video-item d-flex align-items-center p-2 border rounded mb-2" id="video-@videoId">
                                    <img src="@video.ThumbnailUrl" class="rounded me-3"
                                        style="width:120px; height:70px; object-fit:cover;">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 text-truncate">@video.Title</h6>
                                        <small class="text-muted">⏱ @video.Duration | 📺 @video.ChannelName</small>
                                    </div>
                                    <div class="d-flex align-items-center ms-3">
                                        <input type="checkbox" class="form-check-input me-2" id="tick-@videoId"
                                            onclick="markCompleted('@Model.PlanId','@videoId', @day.Day)">
                                        <button class="btn btn-sm btn-outline-primary watch-btn" data-videoid="@videoId"
                                            data-planid="@Model.PlanId">
                                            ▶ Watch
                                        </button>
                                    </div>
                                    <span id="label-@videoId" class="badge bg-success ms-2" style="display:none;">✔</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .accordion-button {
        font-weight: 600;
    }

    .video-item:hover {
        background: #f9f9f9;
    }

    .badge {
        font-size: 0.8rem;
    }
</style>

<script>
    function markCompleted(planId, videoId, day) {
        window.PlanStorage.markVideoCompleted(planId, videoId);
        const tick = document.getElementById("tick-" + videoId);
        tick.checked = true;
        tick.disabled = true;
        document.getElementById("label-" + videoId).style.display = "inline-block";

        updateDayProgress(day, planId);
        updateOverallProgress(planId);
    }

    function updateDayProgress(day, planId) {
        const total = document.querySelectorAll(`#collapse-${day} .video-item`).length;
        let completed = 0;
        document.querySelectorAll(`#collapse-${day} input[type=checkbox]`).forEach(cb => {
            if (cb.checked) completed++;
        });
        document.getElementById("progress-day-" + day).innerText = `${completed} / ${total}`;
    }

    function updateOverallProgress(planId) {
        let total = 0, completed = 0;
        document.querySelectorAll('.video-item input[type=checkbox]').forEach(cb => {
            total++;
            if (cb.checked) completed++;
        });
        const percent = Math.round((completed / total) * 100);
        const bar = document.getElementById("overall-progress");
        bar.style.width = percent + "%";
        bar.innerText = percent + "%";
    }

    document.addEventListener("DOMContentLoaded", () => {

        @foreach (var day in Model.DailyPlan)
            {
                            @foreach (var video in day.Videos)
                {
                    var vid = video.VideoUrl.Split('=')[1];
                    <text>
                        if(window.PlanStorage.isVideoCompleted('@Model.PlanId','@vid')) {
                                                        const tick = document.getElementById("tick-@vid");
                        tick.checked = true;
                        tick.disabled = true;
                        document.getElementById("label-@vid").style.display = "inline-block";
                                                    }
                    </text>
            }
                <text> updateDayProgress(@day.Day, '@Model.PlanId'); </text>
        }
            updateOverallProgress('@Model.PlanId');

        // Watch buttons
        document.querySelectorAll('.watch-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const videoId = btn.getAttribute('data-videoid');
                const planId = btn.getAttribute('data-planid');
                const progressKey = `videoProgress-${planId}-${videoId}`;
                const start = localStorage.getItem(progressKey) || 0;
                window.location.href = `/VideoPlayer/${videoId}?planId=${planId}&start=${start}&highlightVideo=${videoId}`;
            });
        });
    });
</script>
