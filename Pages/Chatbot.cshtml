@page
@model Learning_site.Pages.ChatBotModel
@{
    ViewData["Title"] = "AI Learning Assistant";
}

<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">🎓 EduBot — AI Learning Assistant</h4>
        </div>

        <!-- Chat Window -->
        <div class="card-body position-relative" style="max-height: 550px; overflow-y: auto;" id="chatBox">
            <!-- Loading spinner -->
            <div id="loadingSpinner" class="text-center my-3" style="display:none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            @if (Model.Messages != null && Model.Messages.Count > 0)
            {
                foreach (var msg in Model.Messages)
                {
                    if (msg.Role == "user")
                    {
                        <div class="d-flex justify-content-end mb-3">
                            <div class="p-3 rounded-3 bg-primary text-white shadow-sm" style="max-width: 75%;">
                                <strong>You</strong><br />
                                @msg.Text
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex justify-content-start mb-3">
                            <div class="p-3 rounded-3 bg-light border shadow-sm" style="max-width: 75%;">
                                <strong>EduBot</strong><br />
                                <div class="mt-2">@Html.Raw(msg.TextFormatted)</div>

                                @if (msg.YouTubeVideos?.Count > 0)
                                {
                                    <div class="mt-3">
                                        <strong>📺 Suggested Videos:</strong>
                                        <div class="row mt-2">
                                            @foreach (var vid in msg.YouTubeVideos)
                                            {
                                                <div class="col-md-4 mb-2">
                                                    <a href="@vid.Url" target="_blank" class="text-decoration-none">
                                                        <div class="card h-100">
                                                            <img src="@vid.Thumbnail" class="card-img-top" alt="@vid.Title" />
                                                            <div class="card-body p-2">
                                                                <small>@vid.Title</small>
                                                            </div>
                                                        </div>
                                                    </a>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            }
            else
            {
                <p class="text-muted">Start by asking me a study-related question! 📚</p>
            }
        </div>

        <!-- Input -->
        <div class="card-footer">
            <form method="post" class="d-flex" id="chatForm">
                <input type="text" name="Prompt" class="form-control me-2" placeholder="Type your question..." required />
                <button type="submit" class="btn btn-success">Ask</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var chatBox = document.getElementById("chatBox");
        var spinner = document.getElementById("loadingSpinner");
        var form = document.getElementById("chatForm");

        // Scroll chat to bottom
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;

        // Show spinner on submit
        form.addEventListener("submit", function () {
            spinner.style.display = "block";
        });
    </script>
}
